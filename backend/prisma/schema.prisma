// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  
}

model User {
  id        String            @id @default(cuid())
  email     String            @unique
  name      String?
  password  String
  role      String            @default("USER")
  avatarUrl String?
  lastLoginAt DateTime?
  isActive  Boolean           @default(true)
  chats     Chat[]
  images    ImageGeneration[]
  audioJobs AudioJob[]
  documents Document[]
  hasFaceRegistered Boolean @default(false)
  workspaces    Workspace[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([isActive])
  @@map("users")
}

model Chat {
  id        String    @id @default(cuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  title     String?
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@map("chats")
}

model Message {
  id        String   @id @default(cuid())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId    String
  role      String   @default("USER")
  content   String
  imageUrl  String?
  fileName  String?
  fileUri   String?
  fileMimeType String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatId, createdAt])
  @@index([role])
  @@map("messages")
}

model ImageGeneration {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  prompt    String
  imageUrl  String
  status    String   @default("COMPLETED")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@map("image_generations")
}

model AudioJob {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  type          String   @default("TTS")
  inputText     String?
  inputAudioUrl String?
  outputUrl     String?
  status        String   @default("PENDING")
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("audio_jobs")
}

model Document {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  title     String?
  content   String
  summary   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@map("documents")
}

model Workspace {
  id          String   @id @default(cuid())
  name        String   // e.g., "Game of Thrones Cast"
  description String?
  isDefault   Boolean  @default(false) // Every user needs a default one

  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // A workspace contains many faces
  faces       Face[]
  
  // Settings specific to this workspace (e.g., threshold 0.4 vs 0.6)
  settings    String?  // JSON string storing configs
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Face {
  id          String   @id @default(cuid())
  name        String   // e.g., "Jon Snow"
  imageUrl    String   // Path to the image on disk
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  
  // We track when this face was enrolled
  createdAt   DateTime @default(now())
}

model ExperimentLog {
  id          String   @id @default(cuid())
  type        String   // "RECOGNITION", "LIVENESS", "TWIN_METER"
  result      String   // JSON result
  screenshot  String?  // Path to the image captured
  
  workspaceId String?  // Optional: link log to a workspace
  
  createdAt   DateTime @default(now())
}